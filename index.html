<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI2 Typing Speed Test - School Competition Edition</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
  /* ==============================================
  IMPROVEMENTS AND CHANGES
  ==============================================
  1.  **Elegant Pastel Palette**: Introduced a soft, modern, and cohesive pastel color scheme for a professional look.
  2.  **Enhanced Typography**: Switched to 'Poppins' for UI and 'Roboto Mono' for the typing text for clarity and style.
  3.  **Refined Layout & Spacing**: Increased padding, margins, and used a centered layout for a clean, uncluttered feel.
  4.  **Smooth Animated Transitions**: Screens now fade in gently for a smoother user experience.
  5.  **Precise Blinking Cursor**: The cursor is now perfectly aligned with the text for an intuitive typing feel.
  6.  **FINAL FIX for Jumps & Wrapping**: New method uses pseudo-elements to ensure zero layout shifts while allowing words to wrap correctly.
  7.  **Modern UI Components**: Buttons, inputs, and stat bars are restyled with subtle shadows and hover effects.
  8.  **Responsive Design**: The layout is fully responsive and looks great on desktops, tablets, and mobile devices.
  ==============================================
  */

  :root {
    --primary-bg: #F0F7FF;      /* Light Pastel Blue */
    --secondary-bg: #FFFFFF;    /* Clean White */
    --text-primary: #333333;    /* Soft Black */
    --text-secondary: #757575;  /* Medium Gray */
    --accent-color: #82A0D8;    /* Soft Blue */
    --accent-hover: #6A8AC8;    /* Darker Soft Blue */
    --correct-color: #65B741;   /* Pastel Green */
    --incorrect-color: #FF6B6B; /* Pastel Red */
    --incorrect-bg: #FFEAE4;    /* Light Pink/Red Background */
    --border-color: #DDE6ED;    /* Light Grayish Blue */
    --shadow-color: rgba(100, 100, 150, 0.1);
  }

  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--primary-bg);
    color: var(--text-primary);
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
  }

  header {
    text-align: center;
    margin-bottom: 30px;
  }

  header h1 {
    margin: 0;
    font-size: 2.5em;
    font-weight: 700;
    color: var(--accent-color);
  }

  .container {
    max-width: 850px;
    width: 100%;
    background-color: var(--secondary-bg);
    border-radius: 20px;
    box-shadow: 0 10px 30px var(--shadow-color);
    padding: 40px;
    box-sizing: border-box;
    margin-bottom: 30px;
  }

  /* Screen visibility and transitions */
  .screen {
    display: none;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }
  .screen.active {
    display: block;
    opacity: 1;
  }

  .intro h2 {
    text-align: center;
    margin-bottom: 15px;
    font-size: 2em;
    color: var(--text-primary);
  }

  .intro p {
    font-size: 1.1em;
    line-height: 1.6;
    margin-bottom: 30px;
    text-align: center;
    color: var(--text-secondary);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .input-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
  }

  .input-wrapper {
    width: 100%;
    max-width: 350px;
  }
  
  .input-wrapper label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .input-wrapper input, .input-wrapper select {
    width: 100%;
    padding: 14px 18px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 1em;
    font-family: 'Poppins', sans-serif;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .input-wrapper input:focus, .input-wrapper select:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 4px rgba(130, 160, 216, 0.25);
    outline: none;
  }

  .button {
    background-color: var(--accent-color);
    color: #FFFFFF;
    padding: 15px 40px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.1em;
    font-weight: 500;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    display: block;
    margin: 20px auto 0 auto;
    box-shadow: 0 4px 15px rgba(130, 160, 216, 0.4);
  }

  .button:hover {
    background-color: var(--accent-hover);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(130, 160, 216, 0.5);
  }

  .stats-bar {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin-bottom: 30px;
    padding: 20px;
    background-color: var(--primary-bg);
    border-radius: 12px;
  }
  
  .stat-item {
    font-size: 1.25em;
    color: var(--text-secondary);
    font-weight: 500;
    width: 250px;
    text-align: center;
  }

  #typing-text {
    font-family: 'Roboto Mono', monospace;
    font-size: 1.5em;
    line-height: 2.2; /* Adjusted line-height for padding */
    background-color: #FDFDFD;
    padding: 30px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
    text-align: left;
    position: relative; 
    white-space: pre-wrap;
    overflow-wrap: break-word; 
  }

  .char {
    /* FIX 1: Revert to inline to allow proper word wrapping */
    display: inline;
    position: relative;
    border-radius: 1px;
    padding: 2px 0;
    /* FIX 2: Add padding to reserve space for the pseudo-element underline */
    padding-bottom: 4px;
  }

  .char.correct {
    color: var(--correct-color);
    background-color: #F0FFF0;
  }

  .char.incorrect {
    background-color: var(--incorrect-bg);
    color: var(--incorrect-color);
  }
  
  /* FIX 3: Use a pseudo-element for a stable underline that doesn't cause reflow */
  .char.incorrect::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--incorrect-color);
  }

  /* ===================================================================
     FIX FOR GLITCH: STABLE CURSOR IMPLEMENTATION
     The previous cursor (using a ::before pseudo-element) was replaced
     with a `box-shadow`. A box-shadow does NOT affect the layout or
     dimensions of the element, which prevents the browser from
     re-calculating line wraps and causing the text to "jump".
     This provides a perfectly stable, flicker-free cursor.
     =================================================================== */
  .char.current {
    box-shadow: -2px 0 0 var(--accent-color);
    animation: blink-cursor 1s step-end infinite;
  }

  @keyframes blink-cursor {
    50% {
      box-shadow: -2px 0 0 transparent;
    }
  }
  
  #hidden-input {
    position: absolute;
    left: -9999px;
    top: -9999px;
    opacity: 0;
  }

  .result-area h2 {
    font-size: 2.2em;
    text-align: center;
    margin-bottom: 20px;
  }

  .result-area p {
    font-size: 1.4em;
    line-height: 1.7;
    text-align: center;
  }

  #final-score {
    font-size: 3em;
    color: var(--accent-color);
    font-weight: 700;
    margin: 20px 0;
  }
  
  footer {
    text-align: center;
    color: var(--text-secondary);
    margin-top: auto;
    padding: 20px;
    font-size: 1em;
    width: 100%;
  }

  #infoMsg {
    color: var(--incorrect-color);
    text-align: center;
    margin-top: 20px;
    font-weight: 500;
    min-height: 1.2em; /* Prevent layout shift */
  }
  
  /* Responsive Adjustments */
  @media (max-width: 768px) {
    body { padding: 15px; justify-content: flex-start; }
    .container { padding: 25px; }
    header { margin-bottom: 20px; }
    header h1 { font-size: 2em; }
    #typing-text { font-size: 1.2em; line-height: 1.9; padding: 20px; }
    .stats-bar { flex-direction: column; align-items: center; gap: 15px; }
    .stat-item { width: 100%; font-size: 1.1em; }
  }

</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>

<header>
  <h1>Typing Speed Challenge</h1>
</header>

<div class="container">
  <div id="intro" class="screen active">
    <h2>Welcome to the Competition!</h2>
    <p>Please select your grade, enter your name, and click Start. You will have 60 seconds to type the given text as quickly and accurately as you can. Good luck!</p>
    <div class="input-group">
      <div class="input-wrapper">
        <label for="gradeSelect">Select Your Grade</label>
        <select id="gradeSelect">
          <option value="">-- Please Select --</option>
          <option value="3">Grade 3</option>
          <option value="4">Grade 4</option>
          <option value="5">Grade 5</option>
          <option value="6">Grade 6</option>
          <option value="7">Grade 7</option>
          <option value="8">Grade 8</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
        </select>
      </div>
      <div class="input-wrapper">
        <label for="userName">Enter Your Name</label>
        <input type="text" id="userName" placeholder="e.g., Jane Doe">
      </div>
    </div>
    <button class="button" onclick="startTest()">Start Test</button>
    <div id="infoMsg"></div>
  </div>

  <div id="game-area" class="screen">
    <div class="stats-bar">
      <div class="stat-item" id="timer">Time: 1:00</div>
      <div class="stat-item" id="scoreboard">WPM: 0</div>
      <div class="stat-item" id="accuracy">Accuracy: 100%</div>
    </div>
    <div id="typing-text" onclick="document.getElementById('hidden-input').focus()"></div>
    <input type="text" id="hidden-input" onpaste="return false;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
  </div>

  <div id="result-area" class="screen">
    <h2>Test Complete!</h2>
    <p id="final-message"></p>
    <p id="final-score"></p>
    <p id="final-accuracy"></p>
    <button class="button" onclick="restartTest()">Try Again</button>
  </div>
</div>

<footer>
  <p>&copy; AI2 School Typing Competition. Practice makes perfect!</p>
</footer>

<script>
// ------------------ Firebase Setup ------------------
const firebaseConfig = {
  // Your Firebase config remains unchanged
  apiKey: "AIzaSyB-RDLOoTlaio0VgtFh7eencMr9ekdFEEk",
  authDomain: "test-app-1-6ade5.firebaseapp.com",
  databaseURL: "https://test-app-1-6ade5-default-rtdb.firebaseio.com",
  projectId: "test-app-1-6ade5",
  storageBucket: "test-app-1-6ade5.appspot.com",
  messagingSenderId: "938447574937",
  appId: "1:938447574937:web:65c1c53a12c665988b2508",
  measurementId: "G-FKNLFZH4G9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ------------------ Globals ------------------
let totalTime = 60;
let timerInterval = null;
let userName = "";
let gameRef = null;

let started = false;
let startTime;
let endTime;

const testParagraph = "tom woke up early in the morning. he brushed his teeth and washed his face. he ate bread and milk for breakfast. his mother packed a small bag for him. tom went out to meet his friend anna. they walked to the park together. the sun was shining and the birds were singing. they saw flowers and trees along the way. at the park, they found a place under a big tree. first, they played tag. tom ran fast and anna tried to catch him. they laughed a lot. then they played with a ball. they kicked it to each other. after playing, they sat on the grass and drank water. they talked about school and their favorite games. tom showed anna his notebook. he had drawn pictures of animals. anna liked the pictures and clapped. after that, they ran to the swings. they swung high and felt happy. then they slid down the slide again and again. they saw some other children playing too. everyone was smiling and having fun. later, they walked around the park and counted flowers. tom counted ten red flowers. anna counted five yellow flowers. the afternoon passed quickly. they ran back to the big tree to rest. they ate sandwiches and laughed at funny stories. the sun began to go down. tom and anna packed their bags. they waved goodbye and walked home slowly. tom told his mother about the games he played. anna told her father too. they both felt tired but happy. it was a good day. they learned new things and had fun with friends. they could not wait to meet again and play more games. after dinner, tom wrote in his notebook about the park and the friends he played with. he went to bed smiling. it was a happy day full of fun games friends and laughter.";

let charArray = [];
let currentIndex = 0;
let correctCount = 0;
let errorCount = 0;

// ------------------ UI & State Management ------------------

/**
 * Displays a specific screen ('intro', 'game-area', 'result-area')
 * and hides the others, managing transitions.
 * @param {string} screenId The ID of the screen to show.
 */
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.classList.remove('active');
  });
  const activeScreen = document.getElementById(screenId);
  if (activeScreen) {
    activeScreen.classList.add('active');
    // Scroll to the game area when it becomes active
    if (screenId === 'game-area') {
      activeScreen.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
}

/**
 * Displays an informational or error message to the user.
 * @param {string} msg The message to display.
 */
function showInfo(msg) {
  document.getElementById("infoMsg").textContent = msg;
}

/**
 * Updates the accuracy display on the stats bar.
 * A more intuitive calculation is used: (correct / total_typed) * 100
 */
function updateAccuracyDisplay() {
  let accuracy = 100;
  const totalTyped = correctCount + errorCount;
  if (totalTyped > 0) {
    accuracy = (correctCount / totalTyped) * 100;
  }
  document.getElementById("accuracy").textContent = `Accuracy: ${accuracy.toFixed(0)}%`;
}

// ------------------ Test Flow ------------------

function startTest() {
  userName = document.getElementById("userName").value.trim();
  const grade = document.getElementById("gradeSelect").value;

  if (!grade) {
    showInfo("Please select your grade to continue.");
    return;
  }
  if (!userName) {
    showInfo("Please enter your name to begin.");
    return;
  }
  
  showInfo(""); // Clear previous errors
  showScreen('game-area');

  // Push a new record to Firebase
  gameRef = db.ref("school-typing-results").push();
  gameRef.set({
    name: userName,
    grade: grade,
    startTime: new Date().toISOString(),
    finalWPM: 0,
    accuracy: 0
  });

  // Reset game state
  started = true;
  startTime = new Date();
  currentIndex = 0;
  correctCount = 0;
  errorCount = 0;
  totalTime = 60; 

  // Reset UI
  document.getElementById("timer").textContent = "Time: 1:00";
  document.getElementById("scoreboard").textContent = "WPM: 0";
  document.getElementById("accuracy").textContent = `Accuracy: 100%`;


  renderText(testParagraph);
  
  const hiddenInput = document.getElementById("hidden-input");
  hiddenInput.value = "";
  hiddenInput.focus();

  startTimer();
}

function finishTest() {
  if (!started) return;
  started = false;
  clearInterval(timerInterval);
  endTime = new Date();
  
  showScreen('result-area');

  let finalWPM = calculateWPM(true); // Get final WPM
  let finalAccuracy = 100;
  const totalTyped = correctCount + errorCount;
  if (totalTyped > 0) {
    finalAccuracy = (correctCount / totalTyped) * 100;
  }

  // Display final results
  document.getElementById("final-message").textContent = `Great job, ${userName}! Here are your results:`;
  document.getElementById("final-score").textContent = `${finalWPM.toFixed(1)} WPM`;
  document.getElementById("final-accuracy").textContent = `Accuracy: ${finalAccuracy.toFixed(0)}%`;

  // Update Firebase with final stats
  if (gameRef) {
    gameRef.update({
      endTime: new Date().toISOString(),
      finalWPM: finalWPM,
      accuracy: finalAccuracy
    });
  }
}

function restartTest() {
  if (timerInterval) clearInterval(timerInterval);
  // Reset all state variables
  started = false;
  timerInterval = null;
  gameRef = null;
  
  // Reset UI elements and show the intro screen
  document.getElementById("typing-text").innerHTML = "";
  document.getElementById("hidden-input").value = "";
  showInfo("");
  showScreen('intro');
}

// ------------------ Text & Input Handling ------------------

function renderText(text) {
  charArray = text.split("");
  const container = document.getElementById("typing-text");
  container.innerHTML = ""; // Clear previous text

  charArray.forEach((char, index) => {
    const span = document.createElement("span");
    span.classList.add("char");
    span.textContent = char;
    if (index === 0) span.classList.add("current");
    container.appendChild(span);
  });
}

document.addEventListener("keydown", function(e) {
  if (!started || currentIndex >= charArray.length) return;

  // Always keep focus on the hidden input to capture keystrokes
  document.getElementById("hidden-input").focus();

  const key = e.key;
  if (key === "Backspace") {
    e.preventDefault();
    handleBackspace();
  } else if (key.length === 1) { // Handle single character inputs
    e.preventDefault();
    handleInput(key);
  }
});

function handleInput(charTyped) {
  const spans = document.querySelectorAll(".char");
  const currentSpan = spans[currentIndex];
  const expectedChar = charArray[currentIndex];

  currentSpan.classList.remove("current");

  if (charTyped === expectedChar) {
    currentSpan.classList.add("correct");
    correctCount++;
  } else {
    currentSpan.classList.add("incorrect");
    errorCount++;
  }

  currentIndex++;
  updateAccuracyDisplay();

  if (currentIndex === charArray.length) {
    finishTest();
  } else {
    spans[currentIndex].classList.add("current");
  }
}

function handleBackspace() {
  if (currentIndex === 0) return;

  const spans = document.querySelectorAll(".char");
  spans[currentIndex]?.classList.remove("current");

  currentIndex--;
  const prevSpan = spans[currentIndex];

  // Revert character state
  if (prevSpan.classList.contains("incorrect")) {
    errorCount--;
  } else if (prevSpan.classList.contains("correct")) {
    correctCount--;
  }

  prevSpan.classList.remove("correct", "incorrect");
  prevSpan.classList.add("current");
  
  updateAccuracyDisplay();
}

// ------------------ Timer & WPM Calculation ------------------

function startTimer() {
  const timerEl = document.getElementById("timer");
  timerInterval = setInterval(() => {
    totalTime--;
    const minutes = Math.floor(totalTime / 60);
    let seconds = totalTime % 60;
    if (seconds < 10) seconds = "0" + seconds;
    timerEl.textContent = `Time: ${minutes}:${seconds}`;

    updateWPM();

    if (totalTime <= 0) {
      clearInterval(timerInterval);
      finishTest();
    }
  }, 1000);
}

/**
 * Calculates words per minute (WPM).
 * Standard WPM is based on 5 characters per word (including spaces).
 * @param {boolean} isFinal - Determines if we use the fixed end time or current time.
 * @returns {number} The calculated WPM.
 */
function calculateWPM(isFinal = false) {
  const now = isFinal ? endTime : new Date();
  const elapsedMs = now - startTime;
  if (elapsedMs === 0) return 0;

  const elapsedMin = elapsedMs / 60000;
  // WPM is calculated based on correctly typed characters.
  // The definition of a "word" is standardized to 5 characters.
  const wordsTyped = correctCount / 5.0;
  const wpm = wordsTyped / elapsedMin;
  
  return isNaN(wpm) || !isFinite(wpm) ? 0 : wpm;
}

function updateWPM() {
  const wpm = calculateWPM();
  document.getElementById("scoreboard").textContent = "WPM: " + wpm.toFixed(1);
}

</script>

</body>
</html>
